<html>
<head>
<script>
var selectedId = -1;
function refreshTab() {
  chrome.tabs.getAllInWindow(null,function(tabs){	
	chrome.browserAction.setBadgeText({"text": tabs.length.toString(),tabId: selectedId});
  });
}

chrome.tabs.onUpdated.addListener(function(tabId, props) {
  if (tabId == selectedId)
    refreshTab();
});

chrome.tabs.onSelectionChanged.addListener(function(tabId, props) {
  selectedId = tabId;
  refreshTab();
});

chrome.tabs.getSelected(null, function(tab) {
  selectedId = tab.id;
  refreshTab();
});
</script>
</head>
</html>